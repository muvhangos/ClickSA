<script>
const feeds = [
  { url: 'https://feeds.bbci.co.uk/news/world/rss.xml', region: 'Worldwide/UK' },
  { url: 'https://rss.cnn.com/rss/edition_us.rss', region: 'USA' },
  { url: 'https://allafrica.com/tools/headlines/africa/headlines.xml', region: 'Africa' },
  { url: 'https://www.groundup.org.za/feed/', region: 'South Africa' },
  { url: 'https://www.news24.com/rss', region: 'South Africa' },
  { url: 'https://www.timeslive.co.za/rss/', region: 'South Africa' },
  { url: 'https://ewn.co.za/rss', region: 'South Africa' }
];

const container = document.getElementById('newsContainer');
const liveText = document.getElementById('liveUpdate');
const earthLogo = document.getElementById('earthLogo');
let cache = JSON.parse(localStorage.getItem('cachedNews')) || { time: 0, items: [] };

function animateLiveText() {
  const dots = ['.', '..', '...', ''];
  let i = 0;
  setInterval(() => {
    liveText.textContent = `ðŸ”„ Live Updating${dots[i]}`;
    i = (i + 1) % dots.length;
  }, 600);
}

function glowEarth(active) {
  earthLogo.style.boxShadow = active
    ? '0 0 40px rgba(0, 200, 255, 0.9), 0 0 80px rgba(0, 200, 255, 0.5)'
    : '0 0 20px rgba(0, 200, 255, 0.6)';
}

function renderNews(news) {
  container.innerHTML = '';
  news.slice(0, 25).forEach(article => {
    const card = document.createElement('div');
    card.className = 'news-card';
    card.innerHTML = `
      <img src="${article.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="News Image">
      <div class="news-content">
        <div class="news-title">${article.title}</div>
        <div class="news-desc">${article.description.replace(/<[^>]+>/g,'').substring(0,120)}...</div>
        <div class="news-meta">${article.region}</div>
        <a href="${article.link}" target="_blank">Read More</a>
      </div>`;
    container.appendChild(card);
  });
}

async function fetchFeed(feed) {
  try {
    const response = await fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(feed.url));
    const data = await response.json();
    if (!data.items) return [];
    return data.items.map(item => ({
      title: item.title,
      description: item.description || '',
      link: item.link,
      image: (item.enclosure && item.enclosure.link) || item.thumbnail || '',
      region: feed.region
    }));
  } catch {
    return [];
  }
}

async function loadNews() {
  liveText.style.color = '#00cc66';
  liveText.textContent = 'ðŸ”„ Updating news...';
  glowEarth(true);

  if (Date.now() - cache.time < 60 * 1000 && cache.items.length > 0) {
    renderNews(cache.items);
  } else {
    container.innerHTML = '<p>Loading latest news...</p>';
  }

  const newsCollection = [];

  for (const feed of feeds) {
    fetchFeed(feed).then(feedNews => {
      newsCollection.push(...feedNews);
      const sa = newsCollection.filter(n => n.region === 'South Africa');
      const others = newsCollection.filter(n => n.region !== 'South Africa');
      const sorted = [...sa, ...others].sort(() => 0.5 - Math.random());
      renderNews(sorted);
      cache = { time: Date.now(), items: sorted };
      localStorage.setItem('cachedNews', JSON.stringify(cache));
    });
  }

  setTimeout(() => {
    glowEarth(false);
    liveText.style.color = '#999';
    liveText.textContent = 'âœ… News is Live';
  }, 4000);
}

animateLiveText();
loadNews();
setInterval(loadNews, 60 * 1000);
</script>
